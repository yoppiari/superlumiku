# Coolify Storage Setup for Pose Generator

## Overview

The Pose Generator uses local file storage with persistent volumes in Coolify. This guide walks you through setting up volume mounting for production deployment.

## Phase 4A: Local Storage (Current)

Local storage is the default mode for immediate deployment. Files are stored on the Coolify server's filesystem with proper volume mounting for persistence.

### Architecture

```
/var/lib/docker/volumes/lumiku_uploads/_data  (Host)
            ↓ (Volume Mount)
    /app/backend/uploads                      (Container)
            ↓ (File Structure)
    /app/backend/uploads/poses/{generationId}/{poseId}.png
    /app/backend/uploads/poses/{generationId}/{poseId}_thumb.png
```

### Benefits
- No external dependencies
- Zero additional cost
- Immediate deployment
- Fast file access
- Simple backup strategy

## Step-by-Step Setup

### Step 1: Create Persistent Volume in Coolify

1. Open your Coolify Dashboard
2. Navigate to your Lumiku application
3. Click on the "Storage" tab
4. Click "Add Volume" button
5. Configure the volume:

   ```
   Name:              lumiku-uploads
   Source Path:       (auto-generated by Coolify)
   Destination Path:  /app/backend/uploads
   Mode:              Read/Write
   ```

6. Click "Save"

### Step 2: Configure Environment Variables

In Coolify environment settings, add:

```bash
# Storage Configuration
STORAGE_MODE=local
UPLOAD_PATH=/app/backend/uploads
```

**Important:** Do NOT add R2 credentials unless migrating to cloud storage.

### Step 3: Deploy the Application

1. Commit your changes
2. Push to your repository
3. Coolify will automatically detect changes and redeploy
4. OR manually trigger deployment in Coolify dashboard

### Step 4: Verify Volume Mounting

SSH into the Coolify container to verify:

```bash
# Find your container ID
docker ps | grep lumiku

# SSH into container
docker exec -it <container-id> sh

# Verify directory exists
ls -la /app/backend/uploads

# Should show:
# drwxr-xr-x    2 root     root          4096 [date] poses
```

### Step 5: Test Storage Persistence

1. **Generate a test pose:**
   - Use the Pose Generator frontend
   - Create a new pose generation
   - Wait for completion

2. **Verify files exist:**
   ```bash
   # Inside container
   ls -la /app/backend/uploads/poses/
   ls -la /app/backend/uploads/poses/<generation-id>/

   # Should show:
   # <pose-id>.png
   # <pose-id>_thumb.png
   ```

3. **Test persistence after restart:**
   ```bash
   # Restart the container in Coolify dashboard
   # Then verify files still exist
   ls -la /app/backend/uploads/poses/<generation-id>/
   ```

4. **Check file serving:**
   - Open browser
   - Navigate to: `https://your-domain.com/uploads/poses/<generation-id>/<pose-id>.png`
   - Image should load successfully

## Troubleshooting

### Issue: Volume not mounting

**Symptoms:**
- Error: `ENOENT: no such file or directory, mkdir '/app/backend/uploads/poses'`
- Storage initialization fails

**Solution:**
1. Verify volume configuration in Coolify
2. Ensure destination path is exactly: `/app/backend/uploads`
3. Restart the application
4. Check container logs for storage initialization messages

### Issue: Permission denied

**Symptoms:**
- Error: `EACCES: permission denied, mkdir '/app/backend/uploads/poses'`

**Solution:**
```bash
# SSH into container
docker exec -it <container-id> sh

# Fix permissions
chmod -R 755 /app/backend/uploads
chown -R node:node /app/backend/uploads  # or appropriate user
```

### Issue: Files disappear after restart

**Symptoms:**
- Files exist before restart
- Files missing after restart

**Solution:**
- Volume not properly configured
- Verify volume is persistent (not tmpfs)
- Check Coolify volume configuration
- Recreate volume if necessary

### Issue: Disk space full

**Symptoms:**
- Error: `ENOSPC: no space left on device`

**Solution:**
1. Check disk usage:
   ```bash
   df -h /app/backend/uploads
   ```

2. Clean up old generations:
   ```bash
   # Inside container
   cd /app/backend/uploads/poses
   ls -lt | tail -n 20  # View oldest directories
   rm -rf <old-generation-id>  # Delete if safe
   ```

3. Implement cleanup job (future enhancement)

## Monitoring

### Check Storage Usage

```bash
# SSH into container
docker exec -it <container-id> sh

# Check total storage used
du -sh /app/backend/uploads/poses

# Check per-generation usage
du -sh /app/backend/uploads/poses/*

# Count total files
find /app/backend/uploads/poses -type f | wc -l
```

### Application Logs

Monitor storage operations in application logs:

```bash
# View logs in Coolify
# Look for storage-related messages:

[Storage] Initialized in local mode
[Storage] Local path: /app/backend/uploads
[Storage] Initialized local storage: /app/backend/uploads/poses
[Storage] Saved local files: /app/backend/uploads/poses/{id}/{id}.png
```

## Backup Strategy

### Manual Backup

```bash
# SSH into Coolify host (not container)
cd /var/lib/docker/volumes/lumiku_uploads/_data

# Create backup
tar -czf lumiku-poses-backup-$(date +%Y%m%d).tar.gz poses/

# Copy to safe location
scp lumiku-poses-backup-*.tar.gz user@backup-server:/backups/
```

### Automated Backup (Recommended)

Add to crontab on Coolify host:

```bash
# Daily backup at 2 AM
0 2 * * * cd /var/lib/docker/volumes/lumiku_uploads/_data && tar -czf /backups/lumiku-poses-$(date +\%Y\%m\%d).tar.gz poses/ && find /backups/lumiku-poses-*.tar.gz -mtime +30 -delete
```

## Migration to Cloudflare R2 (Future)

When you're ready to migrate to cloud storage:

### Step 1: Create R2 Bucket

1. Log into Cloudflare Dashboard
2. Navigate to R2 Object Storage
3. Click "Create Bucket"
4. Name: `lumiku-poses`
5. Location: Auto (or choose region)

### Step 2: Create API Tokens

1. Go to R2 > API Tokens
2. Click "Create API Token"
3. Permissions: Object Read & Write
4. Copy credentials:
   - Access Key ID
   - Secret Access Key

### Step 3: Configure Custom Domain (Optional but Recommended)

1. In R2 bucket settings, click "Connect Domain"
2. Add subdomain: `poses.lumiku.com`
3. Configure DNS as instructed
4. Enable custom domain

### Step 4: Update Environment Variables

In Coolify, update:

```bash
# Change storage mode
STORAGE_MODE=r2

# Add R2 credentials
R2_ACCOUNT_ID=your-account-id
R2_ACCESS_KEY_ID=your-access-key-id
R2_SECRET_ACCESS_KEY=your-secret-access-key
R2_BUCKET_NAME=lumiku-poses
R2_PUBLIC_URL=https://poses.lumiku.com
```

### Step 5: Migrate Existing Files (Optional)

Use AWS CLI to sync existing files to R2:

```bash
# Install AWS CLI
apt-get install awscli

# Configure for R2
aws configure --profile r2
# Enter R2 credentials when prompted

# Sync files
aws s3 sync /app/backend/uploads/poses/ s3://lumiku-poses/poses/ \
  --endpoint-url https://<account-id>.r2.cloudflarestorage.com \
  --profile r2
```

### Step 6: Redeploy

1. Commit changes
2. Push to repository
3. Coolify redeploys automatically
4. All new uploads go to R2
5. Old local files remain accessible for backup

### Benefits of R2 Migration

- Scalable storage (no disk space limits)
- CDN-backed delivery (faster global access)
- Automatic redundancy
- No volume management
- Better for multi-instance deployments
- Cost-effective ($0.015/GB storage, egress free with Cloudflare)

## Production Checklist

Before going live, verify:

- [ ] Volume properly mounted in Coolify
- [ ] STORAGE_MODE=local in environment
- [ ] UPLOAD_PATH=/app/backend/uploads
- [ ] Storage initialization logs show success
- [ ] Test pose generation completes
- [ ] Files persist after container restart
- [ ] Images accessible via /uploads/ endpoint
- [ ] Disk space monitoring in place
- [ ] Backup strategy implemented
- [ ] Cleanup strategy planned (future)

## Support

If you encounter issues:

1. Check container logs in Coolify
2. Verify volume configuration
3. Test file permissions
4. Monitor disk space
5. Review troubleshooting section above

For R2 migration questions:
- Cloudflare R2 docs: https://developers.cloudflare.com/r2/
- AWS S3 CLI for R2: https://developers.cloudflare.com/r2/examples/aws/aws-cli/

## Summary

Phase 4A provides production-ready local storage with:
- Persistent volume mounting
- Automatic directory creation
- Thumbnail generation
- Error handling
- Future R2 migration path (single env variable change)

This setup is production-ready for Coolify deployment and can scale to thousands of poses before considering R2 migration.
